{% extends "base.html" %}

{% block title %} Results {% endblock %}

{% block js_includes %}
<script type="text/javascript">
    /*
     * This code excerpt modified from http://www.samaxes.com/2011/09/change-url-parameters-with-jquery/
     * to permit parameters with the same name.
     */
    $('document').ready(function() {
        $("input[type=checkbox]").on("click", function(e) {
            // When a facet checkbox is clicked, append the 
            console.log(this);

            /*
             * queryParameters -> handles the query string parameters
             * queryString -> the query string without the fist '?' character
             * re -> the regular expression
             * m -> holds the string matching the regular expression
             */
            var queryParameters = {};
            var queryString = location.search.substring(1);
            var re = /([^&=]+)=([^&]*)/g;
            var m;
             
            // Creates a map with the query string parameters
            var getVars = new Array();
            while (m = re.exec(queryString)) {
                key = decodeURIComponent(m[1]);
                value = decodeURIComponent(m[2]);

                // Skip empty date field values
                if (key == 'startdate' && value == '') {
                    continue;
                }
                else if (key == 'enddate' && value == '') {
                    continue;
                }

                getVars.push({name: key, value: value});
            }
            
            // append new facet value to query string
            getVars.push({name: $(this).attr('name'), value: $(this).attr('value')});

            /*
             * Replace the query portion of the URL.
             * jQuery.param() -> create a serialized representation of an array or
             *     object, suitable for use in a URL query string or Ajax request.
             */
            location.search = $.param(getVars); // Causes page to reload
        });
    });
</script>
{% endblock %}

{% block content %}

<!-- Main hero unit for a primary marketing message or call to action -->
<div class="row-fluid">
    <div class="span4">
        <div class="well">
            <div class="nav-header well-title">Filters</div>
            <form id="search-form" class="form-search" action="/search" method="get">
            <div class="accordion" id="facets">
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#facets" href="#">
                            Location<span class="pull-right"><i class="icon-chevron-down icon-white"></i></span>
                        </a>
                    </div>
                    <div id="location" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <ul class="column-checklist">
                            {% for location, cardinality in facets.location.items %}
                                <li>
                                    <label class="checkbox">
                                        <input type="checkbox" name="fq" id="location_{{ forloop.counter }}" value="location:{{ location }}" /> {{ location }} ({{ cardinality }})
                                    </label>
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#facets" href="#">
                            Genres<span class="pull-right"><i class="icon-chevron-down icon-white"></i></span>
                        </a>
                    </div>
                    <div id="genres" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <ul class="column-checklist">
                             {% for genre, cardinality in facets.genres.items %}
                                <li>
                                    <label class="checkbox">
                                        <input type="checkbox" name="fq" id="genre_{{ forloop.counter }}" value="genres:{{ genre }}" /> {{ genre }} ({{ cardinality }})
                                    </label>
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#facets" href="#">
                           Printers<span class="pull-right"><i class="icon-chevron-down icon-white"></i></span>
                        </a>
                    </div>
                    <div id="printers" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <ul class="column-checklist">
                            {% for printer, cardinality in facets.printers.items %}
                                <li>
                                    <label class="checkbox">
                                        <input type="checkbox" name="fq" id="printer_{{ forloop.counter }}" value="printers:{{ printer }}" /> {{ printer }} ({{ cardinality }})
                                    </label>
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#facets" href="#">
                            Printing Technology<span class="pull-right"><i class="icon-chevron-down icon-white"></i></span>
                        </a>
                    </div>
                    <div id="printing_technology" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <ul class="column-checklist">
                            {% for pt, cardinality in facets.printing_technology.items %}
                                <li>
                                    <label class="checkbox">
                                        <input type="checkbox" name="fq" id="printing_technology_{{ forloop.counter }}" value="printing_technology:{{ pt }}" /> {{ pt }} ({{ cardinality }})
                                    </label>
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="span8">
        <h1>Results</h1>
        {% for res in results %}
        <p>{{ res.title }}</p>
        {% empty %}
        <p>No results. Please refine your query.</p>
        {% endfor %}
    </div>
</div>

{% endblock %}


            {% for facet, entries in facets.items %}
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#facets" href="#{{ facet }}">
                            {{ facet }}<span class="pull-right"><i class="icon-chevron-down icon-white"></i></span>
                        </a>
                    </div>
                    <div id="{{ facet }}" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <ul class="column-checklist">
                            {% for entry, cardinality in entries.items %}
                                <li>
                                    <label class="checkbox">
                                        <input type="checkbox" name="fq" id="{{ facet }}_{{ forloop.counter }}" value="{{ facet }}:{{ entry }}" /> {{ entry }} ({{ cardinality }})
                                    </label>
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endfor %}

